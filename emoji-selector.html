<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE
The complete set of authors may be found at http://polymer.github.io/AUTHORS
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-styles/default-theme.html">

<!--
`emoji-selector` is a `paper-input-addon` component (see Polymer.PaperInput)
that lets you select an emoji from a list and insert it into a text field.

Since you probably don't remember where each emoji is, it ships with a
search-for-emoji-keywords feature!

Example:

    <paper-input label="needs moar emoji">
      <emoji-selector suffix></emoji-selector>
    </paper-input>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--emoji-selector-background-color` | Background color of the popup | `white`
`--emoji-selector-icon-color` | Color of the category icons | `black`
`--emoji-selector` | Mixin applied to the popup | `{}`
`--emoji-selector-icon` | Mixin applied to the emoji icons | `{}`
`--emoji-selector-icon-hover` | Mixin applied to the emoji icons when hovered | `{}`

You can also use any of the Polymer.PaperInputContainer styles to style the
search input, or the Polymer.PaperTabs and Polymer.PaperTab styles to style
the category tabs.

-->

</style>
<dom-module id="emoji-selector">
  <style>
    :host {
      display: inline-block;
      --paper-tabs-selection-bar-color: var(--default-primary-color);
    }

    paper-tabs {
      height: 30px;
      color: var(--emoji-selector-icon-color, black);
    }

    paper-input {
      --paper-input-container-input: {
        text-align: center;
      };
    };

    iron-pages {
      height: 155px;
    }

    #box {
      background: var(--emoji-selector-background-color, white);
      border-radius: 2px;
      box-shadow: 0 2px 5px 0 rgba(0,0,0,.26);

      position: absolute;

      width: 270px;
      height: 240px;
      font-size: 15px;

      z-index: 2;

      @apply(--emoji-selector);
    }

    @media (max-width: 400px) {
      #box {
        left: -180px;
      }
    }

    .emoji-section {
      height: 100%;
      overflow-y: auto;
      flex-direction: column;
      flex-wrap: wrap;
      padding-left: 8px;
      padding-top: 5px;
    }

    .emoji-icon {
      cursor: pointer;
      text-align: center;
      display: inline-block;
      font-size: 18px;
      line-height: 24px;
      width: 24px;
      height: 24px;

      /* >.< */
      -webkit-transition: all .14s linear;
    	-moz-transition: all .14s linear;
    	-o-transition: all .14s linear;
    	-ms-transition: all .14s linear;
    	transition: all .14s linear;

      @apply(--emoji-selector-icon);
    }

    .emoji-icon:hover {
      transform: scale(1.3, 1.3);
      -webkit-transform: scale(1.3, 1.3);
      @apply(--emoji-selector-icon-hover);
    }
  </style>

  <template>
    <paper-icon-button icon="face"on-click="_onClick"></paper-icon-button>

    <div id="box" hidden>
      <paper-input no-label-float id="searchInput" placeholder="find an emoji!"
        on-input="_onInput">
      </paper-input>

      <paper-tabs selected="{{selected}}" id="tabs" tabindex="0">
        <paper-tab><iron-icon icon="social:mood"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="maps:local-florist"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="maps:local-pizza"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="social:cake"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="maps:directions-walk"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="account-balance"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="perm-phone-msg"></iron-icon></paper-tab>
      </paper-tabs>

      <iron-pages selected="{{selected}}">
        <template is="dom-repeat" items="[[emojis]]" as="category">
          <div class="emoji-section">
            <template is="dom-repeat" items="[[category.items]]">
              <div class="emoji-icon" on-click="_addEmoji" title="{{item.keywords}}">{{item.char}}</div>
            </template>
          </div>
        </template>
        <div class="emoji-section">
          <template is="dom-repeat" id="resultList" items="{{searchResults}}">
            <div class="emoji-icon" on-click="_addEmoji" title="{{item.keywords}}">{{item.char}}</div>
          </template>
        </div>
      </iron-pages>
    </div>
  </template>

</dom-module>

<script>
  Polymer({

    is: 'emoji-selector',

    properties: {
      /**
       * The input element the emojis should be inserted to. If not specified,
       * and the emoji-selector is used as a ``<paper-input>`` suffix element, then
       * `inputTarget` will be this parent `paper-input` element.
       */
      inputTarget: {
        type: Object
      },

      /**
       * The selected category.
       */
      selected: {
        type: Number,
        value: 0
      },

      /**
       * A list of all emojis, split by category.
       */
      emojis: {
        type: Array,
        value: []
      },

      searchResults: {
        type: Array,
        value: []
      }
    },

    ready: function() {
      this.inputTarget = Polymer.dom(this).parentNode;

      var request = new XMLHttpRequest();
      var url = this.resolveUrl('bower_components/emojilib/emojis.json');
      request.open('GET', url, true);
      var self = this;

      request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
          allEmojis = JSON.parse(request.response);
          self._emojisReady(allEmojis);
        }
      };
      request.send();
    },

    _emojisReady: function(emojis) {
      this.emojis = [{ 'name': 'people',  'items' : [ ] },
                  { 'name': 'nature',  'items' : [ ] },
                  { 'name': 'foodanddrink',  'items' : [ ] },
                  { 'name': 'celebration',  'items' : [ ] },
                  { 'name': 'activity',  'items' : [ ] },
                  { 'name': 'travelandplaces', 'items' : [ ] },
                  { 'name': 'objectsandsymbols', 'items' : [ ] },
                  { 'name': 'flags', 'items' : [ ] }];
      var indexes = { 'people' : 0,
                      'nature' : 1,
                      'foodanddrink' : 2,
                      'celebration': 3,
                      'activity' : 4,
                      'travelandplaces': 5,
                      'objectsandsymbols': 6,
                      'flags': 7,
                    };
      this._searchPageIndex = 8;  // the page after the last legit emoji page.

      for (var name in emojis) {
        var category = emojis[name]['category'];
        var index = indexes[category];
        if (index !== undefined) {
          var keywords = emojis[name]['keywords'];
          if (keywords.indexOf(name) == -1)
            keywords.push(name);

          this.emojis[index]['items'].push(
              {'char': emojis[name]['char'],
               'keywords': keywords.join(' ').toLowerCase()});
        }
      }

      this.selected = 0;
    },

    _onClick: function() {
      this.$.searchInput.focus();
      if (this.selected != this._searchPageIndex) {
        this.$.searchInput.value = '';
      }
      this.$.searchInput.selectionStart = 0;

      this.$.box.hidden = !this.$.box.hidden;
      this.$.tabs.notifyResize();
    },

    _addEmoji: function(event) {
      if (!this.inputTarget) {
        return;
      }

      var emoji = event.target.textContent;

      // // iron-textarea has a bindValue
      var value = '';
      if (this.inputTarget.bindValue)
        value  =  this.inputTarget.bindValue;
      else value = this.inputTarget.value;

      // Preserve the cursor position.
      var start = this.inputTarget.selectionStart || value.length;
      var end = this.inputTarget.selectionEnd || value.length + 1;

      var front = value.substring(0, start);
      var back = value.substring(end, value.length);

      // // for iron-textarea mostly.
      if (this.inputTarget.bindValue)
        this.inputTarget.bindValue = front + emoji + back;
      else
        this.inputTarget.value = front + emoji + back;

      // Restore the cursor position.
      this.inputTarget.selectionStart = start + emoji.length;
      this.inputTarget.selectionEnd = start + emoji.length;

      this.inputTarget.focus();

      // Close the box.
      this._onClick();
    },

    _onInput: function(event) {
      var search = this.$.searchInput.value.toLowerCase();
      if (search.trim() == '' && this.selected == this._searchPageIndex) {
        this.selected = 0;
        return;
      }

      if (!this.emojis)
        return;

      this.selected = this._searchPageIndex;
      this.searchResults = [];

      // UGH
      for (var i = 0; i < this.emojis.length; i++) {
        var category = this.emojis[i];
        for (var j = 0; j < category.items.length; j++) {
          if (category.items[j]['keywords'].indexOf(search) != -1) {
            this.push('searchResults',
                {'char': category.items[j]['char'],
                 'keywords': category.items[j]['keywords']});
          }
        }
      }
    }
  });

</script>
