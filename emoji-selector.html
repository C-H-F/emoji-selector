<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE
The complete set of authors may be found at http://polymer.github.io/AUTHORS
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS
-->

<link rel="import" href="./bower_components/polymer/polymer.html">
<link rel="import" href="./bower_components/paper-styles/paper-styles.html">
<link rel="import" href="./bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="./bower_components/iron-pages/iron-pages.html">
<link rel="import" href="./bower_components/iron-icon/iron-icon.html">
<link rel="import" href="./bower_components/iron-icons/iron-icons.html">
<link rel="import" href="./bower_components/iron-icons/social-icons.html">
<link rel="import" href="./bower_components/iron-icons/maps-icons.html">

<link rel="import" href="./bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./bower_components/paper-input/paper-input.html">
<link rel="import" href="./bower_components/paper-input/paper-input-container.html">

<link rel="import" href="./bower_components/paper-input/paper-input-addon-behavior.html">

<script type="text/javascript" language="javascript" src="emoji.json"></script>

<!--
`emoji-selector` is a `paper-input-addon` component (see Polymer.PaperInput)
that lets you select an emoji from a list and insert it into a text field.

Since you probably don't remember where each emoji is, it ships with a
search-for-emoji-keywords feature!

Example:

    <paper-input-container>
      <emoji-selector></emoji-selector>
      <label>boring input</label>
      <input is="iron-input">
    </paper-input-container>

    <paper-input-container>
      <emoji-selector></emoji-selector>
      <label>autogrow-textarea</label>
      <iron-autogrow-textarea class="paper-input-input"></iron-autogrow-textarea>
    </paper-input-container>

-->

<dom-module id="emoji-selector">
  <style>
    :host {
      display: inline;

      /* lol halp */
      position: relative;
      float: right;
      right: -35px;
      top: -35px
    }

    paper-tabs {
      height: 40px;
      margin-bottom: 5px;
      --paper-tabs-selection-bar-color: var(--default-primary-color);
    }

    iron-pages {
      height: 140px;
    }

    #box {
      background: white;
      border-radius: 2px;
      box-shadow: 0 2px 5px 0 rgba(0,0,0,.26);

      position: absolute;

      width: 260px;
      height: 240px;

      z-index: 2;
    }

    @media (max-width: 400px) {
      #box {
        left: -180px;
      }
    }

    .emoji-section {
      height: 100%;
      overflow-y: scroll;
      flex-direction: column;
      flex-wrap: wrap;
      padding-left: 8px;
    }

    .emoji-icon {
      cursor: pointer;
      text-align: center;
      display: inline-block;
      font-size: 18px;
      line-height: 24px;
      width: 24px;
      height: 24px;

      /* >.< */
      -webkit-transition: all .14s linear;
    	-moz-transition: all .14s linear;
    	-o-transition: all .14s linear;
    	-ms-transition: all .14s linear;
    	transition: all .14s linear;
    }

    .emoji-icon:hover {
      transform: scale(1.3, 1.3);
      -webkit-transform: scale(1.3, 1.3);
    }
  </style>

  <template>
    <paper-icon-button icon="face"on-click="_onClick"></paper-icon-button>

    <div id="box" hidden>
      <paper-input id="searchInput"
          placeholder="emoji search" no-label-float
          on-value-changed="_onInput"></paper-input>

      <paper-tabs selected="{{selected}}">
        <paper-tab><iron-icon icon="social:mood"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="maps:local-florist"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="social:notifications"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="maps:directions-car"></iron-icon></paper-tab>
        <paper-tab><iron-icon icon="gesture"></iron-icon></paper-tab>
      </paper-tabs>

      <iron-pages selected="{{selected}}">
        <template is="dom-repeat" items="[[emojis]]" as="category">
          <div class="emoji-section">
            <template is="dom-repeat" items="[[category.items]]">
              <div class="emoji-icon" on-click="_addEmoji" title="{{item.keywords}}">{{item.char}}</div>
            </template>
          </div>
        </template>
        <div class="emoji-section">
          <template is="dom-repeat" id="resultList" items="{{searchResults}}">
            <div class="emoji-icon" on-click="_addEmoji" title="{{item.keywords}}">{{item.char}}</div>
          </template>
        </div>
      </iron-pages>

    </div>
  </template>

</dom-module>

<script>
  Polymer({

    is: 'emoji-selector',

    behaviors: [
      Polymer.PaperInputAddonBehavior
    ],

    properties: {
      /**
       * The selected category.
       */
      selected: {
        type: Number,
        value: 0
      },

      /**
       * A list of all emojis, split by category.
       */
      emojis: {
        type: Array,
        value: []
      },

      searchResults: {
        type: Array,
        value: []
      }
    },

    ready: function() {
      this.emojis = [{ "name": "people",  "items" : [ ] },
                  { "name": "nature",  "items" : [ ] },
                  { "name": "objects", "items" : [ ] },
                  { "name": "places",  "items" : [ ] },
                  { "name": "symbols", "items" : [ ] }];
      var indexes = { "people" : 0,
                      "nature" : 1,
                      "objects": 2,
                      "places" : 3,
                      "symbols": 4};

      for (var name in emojis) {
        var category = emojis[name]['category'];
        if (category) {
          var index = indexes[category];
          var keywords = emojis[name]['keywords'];
          if (keywords.indexOf(name) == -1)
            keywords.push(name);

          this.emojis[index]["items"].push(
              {'char': emojis[name]['char'],
               'keywords': keywords.join(' ').toLowerCase()});
        }
      }

      this.selected = 0;
    },

    _onClick: function() {
      if (this.selected != 5) {
        this.$.searchInput.value = '';
        this.$.searchInput.inputElement.focus();
      }
      this.$.searchInput.inputElement.selectionStart = 0;

      this.$.box.hidden = !this.$.box.hidden;
    },

    _addEmoji: function(event) {
      if (!this._element) {
        return;
      }

      var emoji = event.target.textContent;

      // iron-textarea has a bindValue
      var value = '';
      if (this._element.bindValue)
        value  =  this._element.bindValue;
      else
        value = this._element.value;

      // This is needed to tell the paper-input-container to float the label.
      var needsOnInput = value.length == 0;

      // Preserve the cursor position.
      var start = this._element.selectionStart || value.length;
      var end = this._element.selectionEnd || value.length + 1;

      var front = value.substring(0, start);
      var back = value.substring(end, value.length);

      // for iron-textarea mostly.
      if (this._element.bindValue)
        this._element.bindValue = front + emoji + back;
      else
        this._element.value = front + emoji + back;

      // Restore the cursor position.
      this._element.selectionStart = start + emoji.length;
      this._element.selectionEnd = start + emoji.length;

      this._element.focus();

      if (needsOnInput)
        this._element._onInput();

      // Close the box.
      this._onClick();
    },

    _onInput: function(event) {
      var search = this.$.searchInput.value.toLowerCase();
      if (search.trim() == '' && this.selected == 5) {
        this.selected = 0;
        return;
      }

      if (!this.emojis)
        return;

      this.selected = 5;
      this.searchResults = [];

      // UGH
      for (var i = 0; i < this.emojis.length; i++) {
        var category = this.emojis[i];
        for (var j = 0; j < category.items.length; j++) {
          if (category.items[j]['keywords'].indexOf(search) != -1) {
            this.push('searchResults',
                {'char': category.items[j]['char'],
                 'keywords': category.items[j]['keywords']});
          }
        }
      }
    },

    update: function(state) {
      // Meeep. This should be maybe not like this.
      if (!this._element)
        this._element = state.inputElement;
    }

  });

</script>
